# payment-setup

결제 인프라 구축 가이드를 제공합니다. 1인 SaaS 빌더가 PG 선택부터 프로덕션 결제까지 단계별로 셋업할 수 있도록 안내합니다.

> 이 워크플로우는 tax-guide 스킬과 연동하여 세금계산서 발행을 참조합니다.
> `/mvp-definition` 또는 `/operations-plan` 완료 후 실행을 권장합니다.

## 트리거 조건
* /mvp-definition 또는 /operations-plan 결과가 존재할 때 실행 권장
* output/ideas/{id}-{name}/ 폴더 내 mvp-definition.md 또는 idea.json 참조

## 용어 매핑 (영어 → 한국어)

| 영어 | 한국어 | 설명 |
|------|--------|------|
| PG (Payment Gateway) | 결제 대행사 | 카드사/은행과 가맹점 사이에서 결제를 중개하는 서비스 |
| Recurring Billing | 정기 결제 (구독 결제) | 주기적으로 자동 청구되는 결제 방식 |
| Webhook | 웹훅 | 결제 이벤트 발생 시 서버로 전송되는 HTTP 콜백 |
| Checkout | 결제 페이지 | 사용자가 결제 정보를 입력하는 화면 |
| Dunning | 결제 실패 재시도 | 결제 실패 시 자동 재시도 및 고객 알림 프로세스 |
| Churn | 이탈률 | 구독을 해지하는 고객 비율 |
| MRR | 월간 반복 매출 | Monthly Recurring Revenue |
| ARR | 연간 반복 매출 | Annual Recurring Revenue |
| Proration | 일할 계산 | 요금제 변경 시 남은 기간에 대한 비례 계산 |
| Invoice | 청구서 / 인보이스 | 결제 내역을 기록한 문서 |
| Refund | 환불 | 결제 취소 후 금액 반환 |
| Settlement | 정산 | PG사가 가맹점에 결제 대금을 지급하는 과정 |

## PG 선택 의사결정 트리

아래 질문에 따라 적합한 PG를 선택합니다:

```
해외 고객이 있는가?
├── YES → 해외 결제 필수
│   ├── 구독(정기) 결제인가?
│   │   ├── YES → Stripe Billing
│   │   └── NO → Stripe (단건)
│   └── 한국 + 해외 동시 필요?
│       └── YES → 포트원(PortOne) + Stripe 조합
│
└── NO → 국내 전용
    ├── 구독(정기) 결제인가?
    │   ├── YES → 토스페이먼츠 정기결제 또는 포트원
    │   └── NO → 단건 결제
    │       ├── 간편결제 선호? → 카카오페이 / 네이버페이
    │       └── 카드결제 중심? → 토스페이먼츠 / 나이스페이
    │
    └── 노코드/간편 시작?
        ├── YES → Gumroad / Lemon Squeezy
        └── NO → 토스페이먼츠 API 연동
```

## PG사 비교표

| PG사 | 수수료 | 정산주기 | 해외결제 | 구독지원 | 연동 난이도 | 추천 대상 |
|------|--------|----------|----------|----------|-------------|-----------|
| Stripe | 2.9% + 30¢ (해외) / 3.4% + ₩400 (한국 카드) | 2영업일 (해외), 7영업일 (한국) | ✅ 135+ 통화 | ✅ Stripe Billing | 중간 | 해외 고객 있는 SaaS, 글로벌 서비스 |
| 토스페이먼츠 | 카드 2.5-3.3% | 영업일+1 (D+1) | ❌ | ✅ 정기결제 API | 낮음 | 국내 중심 SaaS, 빠른 정산 필요 |
| 포트원 (PortOne) | PG사 수수료 + 포트원 무료 (v2) | PG사에 따라 상이 | ✅ (연동 PG 의존) | ✅ (연동 PG 의존) | 낮음 | 멀티 PG 통합, PG 교체 유연성 |
| 카카오페이 | 2.5-3.3% | D+1 ~ D+3 | ❌ | ❌ | 낮음 | 간편결제 중심, 소액 결제 |
| 나이스페이 | 카드 2.5-3.0% | D+2 ~ D+5 | ✅ (일부) | ✅ (별도 계약) | 중간 | 대형 커머스, 다양한 결제 수단 |
| Gumroad | 10% + 50¢ | 매주 금요일 | ✅ | ✅ | 매우 낮음 (노코드) | 디지털 제품 판매, 초기 검증 |
| Lemon Squeezy | 5% + 50¢ | 월 2회 | ✅ | ✅ | 매우 낮음 (노코드) | SaaS 구독, MoR(세금 대행) |

> ⚠️ 수수료와 정산주기는 계약 조건, 거래량에 따라 달라집니다. 실제 적용 전 각 PG사 공식 문서를 확인하세요.

### 데이터 신뢰도 등급
모든 수수료/정산 정보에 신뢰도 등급을 표기합니다:
| 등급 | 의미 | 예시 |
|------|------|------|
| A | 검증됨 — 공식 문서 기반 | PG사 공식 요금 페이지 |
| B | 근거 있는 추정 — 업계 평균 | 커뮤니티 공유 데이터, 벤치마크 |
| C | AI 추정 — 참고용 | AI가 생성한 초기 추정치 |

> ⚠️ "이 분석의 수수료 정보는 AI 추정(신뢰도 B-C)이며, 각 PG사 공식 문서에서 최신 요율을 확인하세요."

## 수행 작업

### 1단계: 결제 요구사항 분석
* 사업 모델에 맞는 결제 유형 결정 (구독 / 단건 / 혼합)
* 타겟 고객 지역 확인 (국내 / 해외 / 글로벌)
* 예상 거래량 및 객단가 추정
* idea.json의 business_scale 참조

### 2단계: PG사 선택
* 의사결정 트리에 따라 PG사 선정
* 비교표 기반으로 수수료/정산주기 확인
* 사업자등록증 준비 (국내 PG 필수)

### 3단계: 가격 티어 설계
* 무료(Free) / 기본(Basic) / 프로(Pro) 티어 구성
* 각 티어별 기능 차별화 명시
* 연간 결제 할인율 설정 (보통 20% 할인)
* 가격 앵커링 전략 적용

### 4단계: 구독 결제 설정
* 가격 티어를 PG사에 등록 (Product/Price 생성)
* 무료 체험(Free Trial) 기간 설정 (7일 / 14일 권장)
* 결제 실패 처리(Dunning) 설정
  - 1차 실패: 즉시 재시도
  - 2차 실패: 3일 후 재시도 + 이메일 알림
  - 3차 실패: 7일 후 재시도 + 서비스 제한 경고
  - 최종 실패: 구독 일시 정지 + 복구 안내
* 환불 정책 수립 (14일 이내 전액 환불 권장)
* 세금계산서 연동 (tax-guide 스킬 참조)

### 5단계: 결제 테스트
* 테스트 모드 설정 및 검증
* 프로덕션 전환 체크리스트 확인

## 프로세스 흐름

```
요구사항 분석 → PG 선택 → 가격 티어 설계
    ↓
구독 설정 → Webhook 연동 → 테스트
    ↓
프로덕션 전환 → 모니터링 시작
```

## 결제 테스트 가이드

### 테스트 모드 설정

| PG사 | 테스트 환경 | 설정 방법 |
|------|-------------|-----------|
| Stripe | Test Mode 토글 | Dashboard에서 "Test mode" 활성화, `sk_test_` 키 사용 |
| 토스페이먼츠 | 테스트 API 키 | 개발자 센터에서 테스트용 클라이언트 키 발급 |
| 포트원 | 테스트 모드 | 관리자 콘솔에서 테스트 채널 설정 |

### 테스트 카드 번호

| 용도 | Stripe 테스트 카드 | 설명 |
|------|-------------------|------|
| 성공 | 4242 4242 4242 4242 | 정상 결제 |
| 실패 (카드 거절) | 4000 0000 0000 0002 | 카드 거절 시나리오 |
| 인증 필요 (3D Secure) | 4000 0025 0000 3155 | 3DS 인증 테스트 |
| 잔액 부족 | 4000 0000 0000 9995 | 잔액 부족 시나리오 |

> 토스페이먼츠/포트원은 각 공식 문서에서 테스트 카드 정보를 확인하세요.

### Webhook 테스트

* **Stripe**: Stripe CLI로 로컬 Webhook 테스트
  ```
  stripe listen --forward-to localhost:3000/api/webhooks/stripe
  stripe trigger payment_intent.succeeded
  ```
* **토스페이먼츠**: 테스트 결제 진행 시 자동으로 Webhook 발송
* **공통 확인 사항**:
  - [ ] 결제 성공 이벤트 수신 확인
  - [ ] 결제 실패 이벤트 수신 확인
  - [ ] 구독 생성/갱신/해지 이벤트 수신 확인
  - [ ] 환불 이벤트 수신 확인
  - [ ] Webhook 서명 검증 구현 확인
  - [ ] 중복 이벤트 처리 (멱등성) 확인

### 프로덕션 전환 체크리스트

- [ ] 라이브 API 키로 교체 완료
- [ ] Webhook URL을 프로덕션 엔드포인트로 변경
- [ ] 결제 성공/실패 알림 이메일 설정 완료
- [ ] 에러 모니터링 설정 (Sentry 등)
- [ ] 결제 관련 법적 고지 페이지 작성 (이용약관, 환불 정책)
- [ ] SSL/HTTPS 적용 확인
- [ ] PCI DSS 준수 확인 (PG사 결제창 사용 시 PG사가 처리)
- [ ] 첫 실제 결제 테스트 완료 (소액 자체 결제)

## Micro-SaaS 결제 (business_scale micro/small)

idea.json의 business_scale이 "micro" 또는 "small"인 경우, 최소 비용으로 결제를 시작하는 전략을 제공합니다.

### 트리거 조건
* output/ideas/{id}-{name}/idea.json의 business_scale 값이 "micro" 또는 "small"일 때 자동 활성화

### 간편 결제 링크 (코딩 최소화)

| 방법 | 비용 | 구독 지원 | 설정 시간 | 추천 단계 |
|------|------|-----------|-----------|-----------|
| Stripe Payment Links | 무료 (수수료만) | ✅ | 5분 | MVP 검증 |
| 토스 결제 링크 | 무료 (수수료만) | ❌ | 5분 | 국내 단건 판매 |
| Gumroad | 10% 수수료 | ✅ | 10분 | 디지털 제품 초기 판매 |
| Lemon Squeezy | 5% 수수료 | ✅ | 15분 | SaaS 구독 (세금 대행 포함) |

### 노코드 결제 시작 가이드

#### Stripe Payment Links (해외 고객)
1. Stripe 계정 생성 → Dashboard 접속
2. Products에서 상품/가격 생성
3. Payment Links에서 결제 링크 생성
4. 랜딩 페이지에 링크 삽입
5. 월 비용: $0 (수수료만)

#### Lemon Squeezy (세금 걱정 없이)
1. Lemon Squeezy 계정 생성
2. Store에서 상품 등록
3. Checkout 링크 복사
4. 랜딩 페이지에 삽입
5. 월 비용: $0 (수수료만, MoR로 세금 자동 처리)

#### 토스 결제 링크 (국내 고객)
1. 토스페이먼츠 가입 + 사업자 인증
2. 결제 링크 생성 메뉴에서 상품 등록
3. 생성된 링크를 고객에게 공유
4. 월 비용: $0 (수수료만)

### 월 $0-10 비용으로 시작하는 결제 스택

| 거래 규모 | 추천 스택 | 월 고정비 | 변동비 |
|-----------|-----------|-----------|--------|
| 0-10건/월 | Stripe Payment Links | $0 | 건당 수수료 |
| 10-50건/월 | Stripe Checkout (코드 연동) | $0 | 건당 수수료 |
| 50-200건/월 | Stripe Billing (구독 자동화) | $0 | 건당 수수료 |
| 국내 전용 | 토스페이먼츠 | $0 | 건당 수수료 |

### 핵심 차이점

| 항목 | 기존 (startup/enterprise) | Micro-SaaS (micro/small) |
|------|-------------------------|------------------------|
| PG 연동 | API 직접 연동 | 결제 링크 / 노코드 우선 |
| 가격 티어 | 3-5개 복잡한 플랜 | 1-2개 단순 플랜 |
| 결제 수단 | 카드 + 계좌이체 + 간편결제 | 카드 결제 중심 |
| 세금 처리 | 자체 세금계산서 발행 | MoR 서비스 활용 또는 tax-guide 참조 |
| 초기 투자 | 개발 2-4주 | 1-2시간 설정 |

## 출력 규칙
* output/reports/payment-setup.md에 저장합니다
* 결제 요구사항, PG 선택 근거, 가격 티어, 테스트 결과를 포함합니다
* 모든 수수료에 신뢰도 등급을 표기합니다

> ⚠️ 결제 수수료와 정책은 수시로 변경됩니다. 실제 적용 전 각 PG사 공식 문서를 확인하세요.

## 다음 단계
* 결제 설정 완료 후 → `/kpi-framework`로 매출 지표(MRR, Churn Rate) 추적 설정
* 세금/법적 사항 확인 → `/legal-checklist`로 사업자 등록 및 법적 요건 확인
* 세금계산서 연동 필요 시 → tax-guide 스킬 참조
* 전체 진행률 확인 → `/check-progress`
